<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Pusher Platform example</title>
  </head>
  <body>
    <h1>Pusher Platform example</h1>
    <p>
      This app is the "hello world" of Pusher Platform.
      The app subscribes to a feed.
      The latest items are shown below.
      You can publish things to the feed using the form below it.
      View source or see <a href="https://github.com/pusher/pusher-platform-js">the repository</a> for more info.
    </p>

    <h2>Items in the <code>notifications</code> feed</h2>
    <ol id="feed_items">
    </ol>

    <h2>Publish a new item to the <code>notifications</code> feed</h2>
    <input type="text" id="item_val"/>
    <button id="publish_item">Publish</button>

    <h2>Historical items</h2>
    <ol id="page_items">
    </ol>
    <input type="text" id="page_boundary"/>
    <button id="fetch_page">Fetch page from</button>

    <h2>Status</h2>
    <p>Status: <span id="feed_status">page loaded</span></p>
    <button id="unsubscribe">Unsubscribe</button>

    <h2>All feeds in this Pusher Platform app</h2>
    <ol id="all_feeds">
    </ol>

    <!-- change this URL to "./target/pusher-platform.js" for the built version in the repo -->
    <script src="./target/pusher-platform.js"></script>
    <script src="./target/pusher-platform-secret-authorizer.js"></script>
    <script>
      var service = new PusherPlatform.Service({
        serviceId: '2efb721e-090b-4eda-bc2c-f6c1311208f6',
        authorizer: new PusherPlatform.AuthServerAuthorizer(
          "https://platform-example-authorizer.herokuapp.com/pusherplatform/authorize",
          "jim"  // in a real service this would be a private proof of identity, e.g. a password or session cookie
        )
      });
      var notificationsFeed = service.feed("notifications");
      var notificationsSubscription = notificationsFeed.subscribe({
        lastEventId: "0",
        onOpen: () => {
          console.log("Subscription opened");
          document.getElementById("feed_status").innerText = "subscribed";
        },
        onItem: (item) => {
          var itemEl = document.createElement("li");
          itemEl.innerText = JSON.stringify(item);
          document.getElementById("feed_items").appendChild(itemEl);
        },
        onEnd: () => {
          console.log("Subscription ended");
          document.getElementById("feed_status").innerText = "unsubscribed; refresh to resubscribe";
        },
        onError: (err) => {
          document.getElementById("feed_status").innerText = "error: " + err.toString();
          console.error("Error subscribing to notifications:", err);
        }
      });

      document.getElementById("fetch_page").addEventListener("click", () => {
        document.getElementById("page_items").innerText = "";
        notificationsFeed.fetchOlderThan({
          id: document.getElementById("page_boundary").value,
          limit: 50
        }).then((response) => {
          console.log("Got page", response);
          for (var i = 0; i < response.items.length; i++) {
            var item = response.items[i];
            var itemEl = document.createElement("li");
            itemEl.innerText = JSON.stringify(item);
            document.getElementById("page_items").appendChild(itemEl);
          }
        })
        .catch((error) => { console.error("Could not get page:", error); });
      })

      // Using the same feed as above we can publish any value:
      document.getElementById("publish_item").addEventListener("click", () => {
        notificationsFeed.publish(document.getElementById("item_val").value)
          .then((response) => console.log("Success response when publishing:", response))
          .catch((err) => console.error("Could not publish:", err));
      });

      document.getElementById("unsubscribe").addEventListener("click", () => {
        document.getElementById("feed_status").innerText = "unsubscribing";
        notificationsSubscription.unsubscribe();
      });

      service.listFeeds()
        .then((feeds) => {
          for (var i = 0; i < feeds.length; i++) {
            var feedInfo = feeds[i];
            var listEl = document.createElement("li");
            listEl.appendChild(document.createTextNode(JSON.stringify(feedInfo)));
            document.getElementById("all_feeds").appendChild(listEl);
          }
        })
        .catch((err) => console.error("Could not fetch list of feeds: ", err));
    </script>
  </body>
</html>
